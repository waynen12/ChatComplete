name: Build & Deploy â€“ self-hosted

# â”€â”€â”€â”€â”€ Triggers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches: [ main ]        # build when main is updated
  workflow_dispatch:          # manual â€œRun workflowâ€ button

# â”€â”€â”€â”€â”€ Single job, single runner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  deploy:
    runs-on: self-hosted           # ğŸ‘ˆ targets knowledge-runner
    timeout-minutes: 20

    steps:
    # 1ï¸âƒ£  Checkout repo
    - name: Checkout
      uses: actions/checkout@v4

    # 2ï¸âƒ£  Optional unit tests
    #- name: dotnet test
    #  run: |
      #  dotnet test --configuration Release
      # comment out if you have no tests yet

    # 2ï¸âƒ£  Ensure Qdrant is running via docker-compose
    - name: Start Qdrant if not running
      run: |
        if ! docker ps --format "table {{.Names}}" | grep -q "^qdrant-local$"; then
          echo "Qdrant not running, starting via docker-compose..."
          docker-compose -f docker-compose.qdrant.yml up -d
        else
          echo "Qdrant is already running"
        fi

    - name: Clean publish folder
      run: rm -rf /opt/knowledge-api/out/*

    # 3ï¸âƒ£  Publish the API (self-contained linux-x64)
    - name: Publish Knowledge.Api
      run: |
        cd Knowledge.Api
        dotnet publish -c Release -r linux-x64 \
                       --self-contained true \
                       -o /opt/knowledge-api/out
      # runner user (chatapi) must have write access to /opt/knowledge-api/out

    # 4ï¸âƒ£  Restart systemd service
    - name: Restart service
      run: |
        sudo systemctl restart knowledge-api.service
        sudo systemctl --no-pager status knowledge-api.service
