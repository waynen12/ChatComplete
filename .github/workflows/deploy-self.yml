name: Build & Deploy ‚Äì self-hosted

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Triggers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
on:
  push:
    branches: [ main ]        # build when main is updated
  workflow_dispatch:          # manual ‚ÄúRun workflow‚Äù button

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Single job, single runner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
jobs:
  deploy:
    runs-on: self-hosted           # üëà targets knowledge-runner
    timeout-minutes: 20

    steps:
    # 1Ô∏è‚É£  Checkout repo
    - name: Checkout
      uses: actions/checkout@v4

    # üêõ Debug: Verify runner user and sudo configuration
    - name: Debug runner environment
      run: |
        echo "Current user: $(whoami)"
        echo "User ID: $(id)"
        echo "Sudoers configuration for current user:"
        sudo grep -E "^$(whoami)|^%$(whoami)" /etc/sudoers /etc/sudoers.d/* 2>/dev/null || echo "No sudoers entries found"
        echo "Testing sudo without password:"
        sudo -n systemctl status knowledge-api.service || echo "Sudo requires password"

    # 2Ô∏è‚É£  Optional unit tests
    #- name: dotnet test
    #  run: |
      #  dotnet test --configuration Release
      # comment out if you have no tests yet

    # 2Ô∏è‚É£  Ensure Qdrant is running via docker-compose
    - name: Start Qdrant if not running
      run: |
        if ! docker ps --format "table {{.Names}}" | grep -q "^qdrant-local$"; then
          echo "Qdrant not running, starting via docker-compose..."
          docker-compose -f docker-compose.qdrant.yml up -d
        else
          echo "Qdrant is already running"
        fi

    - name: Clean publish folder
      run: rm -rf /opt/knowledge-api/out/*

    # 3Ô∏è‚É£  Publish the API (self-contained linux-x64)
    - name: Publish Knowledge.Api
      run: |
        cd Knowledge.Api
        dotnet publish -c Release -r linux-x64 \
                       --self-contained true \
                       -o /opt/knowledge-api/out
      # runner user (chatapi) must have write access to /opt/knowledge-api/out

    # 4Ô∏è‚É£  Restart systemd service
    - name: Restart service
      run: |
        sudo systemctl restart knowledge-api.service
        sudo systemctl --no-pager status knowledge-api.service

    # ========== MCP Server Deployment ==========
    # Prerequisites (one-time manual setup on test machine):
    #   1. sudo mkdir -p /opt/knowledge-mcp/out
    #   2. sudo chown -R chatapi:chatapi /opt/knowledge-mcp
    #   3. Create systemd service: knowledge-mcp.service

    # 5Ô∏è‚É£  Clean and publish MCP
    - name: Clean MCP publish folder
      run: rm -rf /opt/knowledge-mcp/out/*

    - name: Publish Knowledge.Mcp
      run: |
        cd Knowledge.Mcp
        dotnet publish -c Release -r linux-x64 \
                       --self-contained true \
                       -o /opt/knowledge-mcp/out

    # 6Ô∏è‚É£  Restart MCP service
    - name: Restart MCP service
      run: |
        sudo systemctl restart knowledge-mcp.service
        sleep 5
        sudo systemctl --no-pager status knowledge-mcp.service

    # 7Ô∏è‚É£  Verify MCP health
    - name: Verify MCP health
      run: |
        echo "Waiting for MCP server to start..."
        for i in {1..30}; do
          if curl -f http://localhost:5001/health 2>/dev/null; then
            echo "‚úÖ MCP server is healthy"
            exit 0
          fi
          echo "Attempt $i/30: MCP not ready yet..."
          sleep 2
        done
        echo "‚ùå MCP server failed health check"
        echo "Recent logs:"
        sudo journalctl -u knowledge-mcp.service --no-pager -n 50
        exit 1
